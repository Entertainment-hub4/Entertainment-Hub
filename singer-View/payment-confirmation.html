<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Confirmation</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: url("../Images/rox.jpg") no-repeat center center fixed;
  background-size: cover;
  color: white;
}

.container {
  max-width: 1080px;
  margin: 0 auto;
  padding: 20px;
}

h2 {
  text-align: center;
  background: black;
  padding: 15px 0;
  border-radius: 8px;
  margin-bottom: 30px;
}

/* Loading spinner */
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #22c55e;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.payment-request {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  color: black;
  padding: 12px 20px;
  margin-bottom: 15px;
  border-radius: 8px;
}

.payment-request div {
  flex: 1;
  text-align: center;
}

button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  background: #22c55e;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

button:disabled {
  background: grey;
  cursor: not-allowed;
}
</style>
</head>
<body>
<div class="container">
  <h2>Payment Confirmation Needed</h2>
  <div id="requestsContainer">
    <p>Loading pending payments...</p>
    <div class="spinner"></div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- Supabase Setup ---
const supabaseUrl = 'https://wrbkasrgzgnwgnaoohdq.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyYmthc3Jnemdud2duYW9vaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODQ5OTYsImV4cCI6MjA4MTU2MDk5Nn0.POQp17bLTyxdj5Czs82ItFt_9r3ekyVTxhq4k40G8rU';
const supabase = createClient(supabaseUrl, supabaseKey);

const requestsContainer = document.getElementById("requestsContainer");

// --- Fetch pending payments ---
async function fetchPendingPayments() {
  requestsContainer.innerHTML = '<p>Loading pending payments...</p><div class="spinner"></div>';

  const { data, error } = await supabase
    .from('requests')
    .select('id, singer, tip_amount, payment_method')
    .eq('payment_confirmed', false)
    .order('created_at', { ascending: true });

  if(error){
    console.error(error);
    requestsContainer.innerHTML = "<p>Error loading payments</p>";
    return;
  }

  if(!data || data.length === 0){
    requestsContainer.innerHTML = "<p>No pending payments</p>";
    return;
  }

  requestsContainer.innerHTML = '';
  data.forEach(req => {
    const div = document.createElement('div');
    div.className = 'payment-request';
    div.innerHTML = `
      <div>${req.tip_amount}</div>
      <div>${req.payment_method}</div>
      <button onclick="confirmPayment(${req.id})">Confirm Payment</button>
    `;
    requestsContainer.appendChild(div);
  });
}

// --- Confirm payment ---
async function confirmPayment(id){
  const { data, error } = await supabase
    .from('requests')
    .update({ payment_confirmed: true })
    .eq('id', id);

  if(error){
    console.error("Error confirming payment:", error);
    return;
  }

  fetchPendingPayments(); // refresh list
}

// Initial fetch and auto-refresh every 5s
fetchPendingPayments();
setInterval(fetchPendingPayments, 5000);
</script>
</body>
</html>